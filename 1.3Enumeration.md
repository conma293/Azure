- Azure Portal
- Default User Permissions
- [AzureAD Module](https://github.com/conma293/Azure/blob/main/1.3Enumeration.md#azuread-module)
  - [Users](https://github.com/conma293/Azure/blob/main/1.3Enumeration.md#azuread-module---users)
  - [Groups](https://github.com/conma293/Azure/blob/main/1.3Enumeration.md#azuread-module---groups)
  - [Roles](https://github.com/conma293/Azure/blob/main/1.3Enumeration.md#azuread-module---roles)
  - [Devices](https://github.com/conma293/Azure/blob/main/1.3Enumeration.md#azuread-module---devices)
  - [Apps](https://github.com/conma293/Azure/blob/main/1.3Enumeration.md#azuread-module---apps)
  - [Service Principals](https://github.com/conma293/Azure/blob/main/1.3Enumeration.md#azuread-module---service-principals)

# Enumeration

#### Azure Portal
https://portal.azure.com
- The Azure Portal is a web console that can be used to manage Azure account and its resources.
- It is a GUI alternative to tools like PowerShell modules and Azure cli.

#### Default User Permissions
A normal user has many interesting permissions in Azure AD!
- Read all users, Groups, Applications, Devices, Roles, Subscriptions, and their public properties
- Invite Guests
- Create Security groups
- Read non-hidden Group memberships
- Add guests to Owned groups
- Create new application
- Add up to 50 devices to Azure

* * *

### Powershell shorthand
```|```  pipe
```|measure``` counts returned objects

```?``` means ```Where``` condition - _Where is Powershell defacto filtering mechanism_

```$_``` means current object

* * * 

#### AzureAD Module
AzureAD is a PowerShell module from Microsoft for managing Azure AD.

NOTE:- _AAD Graph is more stealthy than MS Graph due to the latters additional security features so use AAD while you can_
- Does not show all the properties of Azure AD objects and the documentation is not good. Still useful to some extent!
- Can be used only to interact with Azure AD, no access to Azure resources.
- Please note that if the module is not present on your machine, you can use Install Module AzureAD command (needs internet)
- or Download it from PowerShell Gallery https://www.powershellgallery.com/packages/AzureAD rename the .nukpkg to .zip and extract it
  
```
Import-Module C:\AzAD\Tools\AzureAD\AzureAD.psd1
```
To be able to use PowerShell module, we must connect to Azure AD first:
```Connect-AzureAD```

- Using credentials from command line (PSCredential object can be used too)

```
$creds= Get-Credential
Connect-AzureAD -Credential $creds
```
OR
```
$passwd= ConvertTo-SecureString "V3ryH4rdt0Cr4ckN0OneCr4ckTh!sP@ssw0rd" -AsPlainText -Force
$creds= New-Object System.Management.Automation.PSCredential ("test@defcorphq.onmicrosoft.com", $passwd)
Connect-AzureAD -Credential $creds
```

* * * 

- Get the current session state:
```Get-AzureADCurrentSessionInfo```

- Get details of the current tenant:
```Get-AzureADTenantDetail```


#### AzureAD Module - Users
• Enumerate all users:
```Get-AzureADUser -All $true```

• Enumerate a specific user:
```Get-AzureADUser -ObjectId test@defcorphq.onmicrosoft.com```

• Search for a user based on string in first characters of DisplayName or userPrincipalName (wildcard not supported):
```Get-AzureADUser -SearchString "admin"```

• Search for users who contain the word "admin" in their Display name:
```Get-AzureADUser -All $true |?{$_.Displayname -match "admin"}```

• List all the attributes for a user:
```Get-AzureADUser -ObjectId test@defcorphq.onmicrosoft.com | fl * ```
OR
```Get-AzureADUser -ObjectId test@defcorphq.onmicrosoft.com |%{$_.PSObject.Properties.Name}```

• Search attributes for all users that contain the string "password":
```
Get-AzureADUser -All $true |%{$Properties =$_;$Properties.PSObject.Properties.Name | % {if($Properties.$_ -match 'password'){"$($Properties.UserPrincipalName) - $_ -$($Properties.$_)"}}}
```

•  All users who are synced from on-prem:
```Get-AzureADUser -All $true |?{$_.OnPremisesSecurityIdentifier -ne $null}```

•  All users who are from Azure AD:
```Get-AzureADUser -All $true | ?{$_.OnPremisesSecurityIdentifier -eq $null}```

•  Objects created by any user (use -ObjectId for a specific user):
```Get-AzureADUser | Get-AzureADUserCreatedObject```

•  Objects owned by a specific user:
```Get-AzureADUserOwnedObject -ObjectId test@defcorphq.onmicrosoft.com```

#### AzureAD Module - Groups


•  List all Groups:
```Get-AzureADGroup -All $true```

•   Enumerate a specific group:
```Get-AzureADGroup -ObjectId 783a312d-0de2-4490-92e4-539b0e4ee03e```

•  Search for a group based on string in first characters of DisplayName (wildcard not supported):
```Get-AzureADGroup -SearchString "admin" | fl *```

• To search for groups which contain the word "admin" in their name:
```Get-AzureADGroup -All $true |?{$_.Displayname -match "admin"}```

•  Get Groups that allow Dynamic membership (Note the cmdlet name)
```Get-AzureADMSGroup | ?{$_.GroupTypes -eq 'DynamicMembership'}```

•  All groups that are synced from on-prem (note that security groups are not synced):
```Get-AzureADGroup -All $true | ?{$_.OnPremisesSecurityIdentifier -ne $null}```

•  All groups that are from Azure AD:
```Get-AzureADGroup -All $true | ?{$_.OnPremisesSecurityIdentifier -eq $null}```

•  Get members of a group:
```Get-AzureADGroupMember -ObjectId 783a312d-0de2-4490-92e4-539b0e4ee03e```

•  Get groups and roles where the specified user is a member
```
Get-AzureADUser -SearchString 'test' | Get-AzureADUserMembership
Get-AzureADUserMembership -ObjectId test@defcorphq.onmicrosoft.com
```

#### AzureAD Module - Roles

•  Get all available role templates:
```Get-AzureADDirectoryroleTemplate```

•  Get all enabled roles (a user is assigned the role at least once):
```Get-AzureADDirectoryRole```

•  Enumerate users to whom roles are assigned:
```Get-AzureADDirectoryRole -Filter "DisplayName eq 'Global Administrator'" | Get-AzureADDirectoryRoleMember```

•  Get all Azure joined and registered devices
```Get-AzureADDevice -All $true | fl *```

•  Get the device configuration object (note the RegistrationQuota in the output):
```Get-AzureADDeviceConfiguration | fl *```

•  List all the active devices (and not the stale devices):
```Get-AzureADDevice -All $true | ?{$_.ApproximateLastLogonTimeStamp -ne $null}```

#### AzureAD Module - Devices



•    List Registered owners of all the devices:
```
Get-AzureADDevice -All $true | Get-AzureADDeviceRegisteredOwner
Get-AzureADDevice -All $true | %{if($user=Get-AzureADDeviceRegisteredOwner -ObjectId $_.ObjectID){$_;$user.UserPrincipalName;"`n"}}
```

•    List Registered users of all the devices:
```
Get-AzureADDevice -All $true | Get-AzureADDeviceRegisteredUser
Get-AzureADDevice -All $true | %{if($user=Get-AzureADDeviceRegisteredUser -ObjectId $_.ObjectID){$_;$user.UserPrincipalName;"`n"}}
```

•    List devices owned by a user:
```Get-AzureADUserOwnedDevice -ObjectId michaelmbarron@defcorphq.onmicrosoft.com```


•    List devices registered by a user:
```Get-AzureADUserRegisteredDevice -ObjectId michaelmbarron@defcorphq.onmicrosoft.com```


•    List devices managed using Intune:
```Get-AzureADDevice -All $true | ?{$_.IsCompliant -eq "True"}```
                                                                                                62
#### AzureAD Module - Apps

•   Get all the application objects registered with the current tenant (visible in App Registrations in
Azure portal). 
_An application object is the global representation of an app_
```
Get-AzureADApplication -All $true
```


•   Get all details about an application:
```Get-AzureADApplication -ObjectId a1333e88-1278-41bf-8145-155a069ebed0 | fl *```

•   Get an application based on the display name:
```Get-AzureADApplication -All $true | ?{$_.DisplayName -match "app"}```

•   The  Get-AzureADApplicationPasswordCredential will show the applications with an application password but password value is not shown. List all the apps with an application password:
```Get-AzureADApplication -All $true | %{if(Get- AzureADApplicationPasswordCredential -ObjectID $_.ObjectID){$_}}```

•  Get owner of an application
```Get-AzureADApplication -ObjectId a1333e88-1278-41bf-8145-155a069ebed0 | Get-AzureADApplicationOwner |fl *```

•  Get Apps where a User has a role (exact role is not shown):
```Get-AzureADUser -ObjectId roygcain@defcorphq.onmicrosoft.com | Get- AzureADUserAppRoleAssignment | fl *```

•  Get Apps where a Group has a role (exact role is not shown)
```Get-AzureADGroup -ObjectId 57ada729-a581-4d6f-9f16-3fe0961ada82 | Get-AzureADGroupAppRoleAssignment | fl *```


#### AzureAD Module - Service Principals
- Enumerate Service Principals (visible as Enterprise Applications in Azure Portal). 
  - Service principal is local representation for an app in a specific tenant and it is the security object that has privileges.
  -  _This is the 'service account'!_
  - Service Principals can be assigned Azure roles.

•    Get all service principals:
```Get-AzureADServicePrincipal -All $true```

•    Get all details about a service principal:
```Get-AzureADServicePrincipal -ObjectId cdddd16e-2611-4442-8f45-053e7c37a264 | fl *```

•    Get an service principal based on the display name:
```Get-AzureADServicePrincipal -All $true | ?{$_.DisplayName -match "app"}```

•    List all the service principals with an application password:
```Get-AzureADServicePrincipal -All $true | %{if(Get-AzureADServicePrincipalKeyCredential - ObjectID $_.ObjectID){$_}}```

•  Get owner of a service principal:
```Get-AzureADServicePrincipal -ObjectId cdddd16e-2611-4442-8f45-053e7c37a264 | Get-AzureADServicePrincipalOwner |fl *```

•  Get objects owned by a service principal:
```Get-AzureADServicePrincipal -ObjectId cdddd16e-2611-4442-8f45-053e7c37a264 | Get-AzureADServicePrincipalOwnedObject```

•  Get objects created by a service principal
```Get-AzureADServicePrincipal -ObjectId cdddd16e-2611-4442-8f45-053e7c37a264 | Get-AzureADServicePrincipalCreatedObject```

•  Get group and role memberships of a service principal
```Get-AzureADServicePrincipal -ObjectId cdddd16e-2611-4442-8f45-053e7c37a264 | Get-AzureADServicePrincipalMembership |fl *```


































